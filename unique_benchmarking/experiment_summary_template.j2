<!-- Test Summary Table -->
<div style="margin-bottom: 30px;">
    <h3 style="margin-bottom: 10px; color: #333;">Test Summary</h3>
    <table style="border-collapse: collapse; width: 100%; border: 1px solid #ddd;">
        <thead style="background-color: #f5f5f5;">
            <tr>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Total Tests</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Completed Tests</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Failed Tests</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Success Rate</th>
                {% if has_question_results %}
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Questions</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Golden Answers</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            <tr>
                <td style="border: 1px solid #ddd; padding: 8px;">{{total_tests}}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">{{completed_tests}}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">{{failed_tests}}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">
                    {% if total_tests > 0 %}
                        {{success_rate|round(2)}}%
                    {% else %}
                        N/A
                    {% endif %}
                </td>
                {% if has_question_results %}
                <td style="border: 1px solid #ddd; padding: 8px;">{{question_results|length}}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">
                    {% set golden_count = question_results|selectattr("golden_answer")|list|length %}
                    {{golden_count}}
                </td>
                {% endif %}
            </tr>
        </tbody>
    </table>
</div>

<!-- Average Time Metrics per Assistant Table (shown for legacy format or when available) -->
{% if not has_question_results or average_time_per_assistant %}
<div style="margin-bottom: 30px;">
    <h3 style="margin-bottom: 10px; color: #333;">Average Time Metrics per Assistant</h3>
    {% if average_time_per_assistant %}
    <table style="border-collapse: collapse; width: 100%; border: 1px solid #ddd;">
        <thead style="background-color: #f5f5f5;">
            <tr>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Assistant ID</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Search Time (s)</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Crawl Time (s)</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Execution Time (s)</th>
            </tr>
        </thead>
        <tbody>
            {% for assistant_id in average_time_per_assistant.keys()|sort %}
            <tr>
                <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">{{assistant_id}}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">
                    {{average_time_per_assistant[assistant_id].get('search_time', 0.0)|round(2)}}
                </td>
                <td style="border: 1px solid #ddd; padding: 8px;">
                    {{average_time_per_assistant[assistant_id].get('crawl_time', 0.0)|round(2)}}
                </td>
                <td style="border: 1px solid #ddd; padding: 8px;">
                    {{average_time_per_assistant[assistant_id].get('execution_time', 0.0)|round(2)}}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #6c757d; font-style: italic;">Time metrics not available for this experiment.</p>
    {% endif %}
</div>
{% endif %}

{% if has_question_results %}
<!-- Question-Centric Results -->
<div style="margin-top: 30px;">
    <h3 style="margin-bottom: 10px; color: #333;">Question-Centric Results</h3>
    
    {% for question_result in question_results %}
    <div style="margin-bottom: 40px; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; background-color: #f8f9fa;">
        <!-- Question Header -->
        <h4 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.2em;">
            🔤 Question {{loop.index}}: {{question_result.question}}
        </h4>
        
        <!-- Question Metrics -->
        <div style="margin-bottom: 20px; display: flex; gap: 20px; flex-wrap: wrap;">
            <div style="background: #e8f5e8; padding: 8px 12px; border-radius: 4px;">
                <strong>Total:</strong> {{question_result.total_assistants}}
            </div>
            <div style="background: #d4edda; padding: 8px 12px; border-radius: 4px;">
                <strong>Successful:</strong> {{question_result.successful_assistants}}
            </div>
            <div style="background: #f8d7da; padding: 8px 12px; border-radius: 4px;">
                <strong>Failed:</strong> {{question_result.failed_assistants}}
            </div>
            <div style="background: #d1ecf1; padding: 8px 12px; border-radius: 4px;">
                <strong>Success Rate:</strong> {{question_result.success_rate|round(1)}}%
            </div>
        </div>
        
        <!-- Golden Answer -->
        {% if question_result.golden_answer %}
        <div style="margin-bottom: 25px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 15px;">
            <h5 style="color: #856404; margin-bottom: 10px;">🏆 Golden Answer</h5>
            <div style="font-size: 0.9em; color: #6c757d; margin-bottom: 10px;">
                <strong>Model:</strong> {{question_result.golden_answer.model}} | 
                <strong>Generation Time:</strong> {{question_result.golden_answer.generation_time|round(2)}}s
            </div>
            <div style="background: white; padding: 12px; border-radius: 4px; border: 1px solid #dee2e6;">
                {{question_result.golden_answer.answer|safe}}
            </div>
        </div>
        {% endif %}
        
        <!-- Assistant Results Table -->
        <h5 style="color: #495057; margin-bottom: 10px;">🤖 Assistant Results</h5>
        <table style="border-collapse: collapse; width: 100%; border: 1px solid #ddd; background: white;">
            <thead style="background-color: #6c757d; color: white;">
                <tr>
                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left; width: 15%;">Assistant ID</th>
                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left; width: 12%;">Chat ID</th>
                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left; width: 8%;">Status</th>
                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left; width: 40%;">Response</th>
                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left; width: 8%;">Hallucination</th>
                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left; width: 8%;">Duration</th>
                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left; width: 9%;">Score (0-5)</th>
                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left; width: 20%;">Reviewer Comments</th>
                </tr>
            </thead>
            <tbody>
                {% for result in question_result.assistant_results %}
                <tr {% if loop.index is even %}style="background-color: #f8f9fa;"{% endif %}>
                    <td class="assistant-id" style="border: 1px solid #ddd; padding: 8px; font-family: monospace; font-size: 0.85em;">
                        {{result.assistant_id}}
                    </td>
                    <td class="chat-id" style="border: 1px solid #ddd; padding: 8px; font-family: monospace; font-size: 0.85em;">
                        {{result.message.chatId if result.message else "N/A"}}
                    </td>
                    <td class="status-cell" style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                        {% if result.success %}✅{% else %}❌{% endif %}
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <div class="answer-content" style="max-height: 150px; overflow-y: auto; line-height: 1.4;">
                            {% if result.message and result.message.text %}
                                {{result.message.text|safe}}
                            {% else %}
                                <em style="color: #6c757d;">No response available</em>
                            {% endif %}
                        </div>
                    </td>
                    <td class="status-cell" style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                        {% if result.message and result.message.assessment %}
                            {% set assessment = result.message.assessment[0] %}
                            {% if assessment.label == "GREEN" %}🟢
                            {% elif assessment.label == "YELLOW" %}🟡
                            {% elif assessment.label == "RED" %}🔴
                            {% else %}❌
                            {% endif %}
                        {% else %}❌{% endif %}
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 0.9em;">
                        {{result.execution_time|round(2)}}s
                    </td>
                    <td class="score-cell" style="border: 1px solid #ddd; padding: 4px;">
                        <select class="score-selector" data-test-id="{{result.test_id}}" style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="">Select Score</option>
                            <option value="5">⭐⭐⭐⭐⭐ Outstanding</option>
                            <option value="4">⭐⭐⭐⭐☆ Good</option>
                            <option value="3">⭐⭐⭐☆☆ Adequate</option>
                            <option value="2">⭐⭐☆☆☆ Incomplete</option>
                            <option value="1">⭐☆☆☆☆ Poor</option>
                            <option value="0">☆☆☆☆☆ Irrelevant / No Answer</option>
                        </select>
                    </td>
                    <td class="comments-cell" style="border: 1px solid #ddd; padding: 4px;">
                        <textarea class="comment-field" data-test-id="{{result.test_id}}" 
                                  placeholder="Enter your detailed feedback about this response..." 
                                  style="width: 100%; min-height: 60px; padding: 6px; border: 1px solid #ccc; border-radius: 4px; resize: vertical; font-family: inherit; font-size: 0.9em; line-height: 1.4;"
                                  rows="3"></textarea>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endfor %}
</div>

{% else %}

<!-- Legacy Detailed Test Results Table -->
<div style="margin-top: 30px;">
    <h3 style="margin-bottom: 10px; color: #333;">Detailed Test Results (Legacy Format)</h3>
    <table style="border-collapse: collapse; width: 100%; border: 1px solid #ddd;">
        <thead style="background-color: #f5f5f5;">
            <tr>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left; width: 10%;">Assistant ID</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left; width: 10%;">Chat ID</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left; width: 5%;">Status</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left; width: 18%;">Question</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left; width: 35%;">Answer</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left; width: 6%;">Hallucination Level</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left; width: 8%;">Assessment</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left; width: 6%;">Human Score (0-5)</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left; width: 20%;">Reviewer Comments</th>
            </tr>
        </thead>
        <tbody>
            {% for assistant in results -%}
            <tr>
                <td class="assistant-id" style="border: 1px solid #ddd; padding: 8px;">{{assistant.assistant_id}}</td>
                <td class="chat-id" style="border: 1px solid #ddd; padding: 8px;">{{assistant.chat_id}}</td>
                <td class="status-cell" style="border: 1px solid #ddd; padding: 8px;">{{assistant.status}}</td>
                <td class="question-cell" style="border: 1px solid #ddd; padding: 8px;">{{assistant.question}}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">
                    <div class="answer-content" style="max-height: 200px; overflow-y: auto; line-height: 1.4;">
                        {{assistant.answer|safe}}
                    </div>
                </td>
                <td class="status-cell" style="border: 1px solid #ddd; padding: 8px;">{{assistant.hallucination_level}}</td>
                <td class="assessment-cell" style="border: 1px solid #ddd; padding: 8px;">{{assistant.assessment}}</td>
                <td class="score-cell" style="border: 1px solid #ddd;">
                    <select class="score-selector" data-test-id="{{assistant.test_id}}" style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="">Select Score</option>
                        <option value="5">⭐⭐⭐⭐⭐ Outstanding (5)</option>
                        <option value="4">⭐⭐⭐⭐☆ Very Good (4)</option>
                        <option value="3">⭐⭐⭐☆☆ Adequate</option>
                        <option value="2">⭐⭐☆☆☆ Incomplete</option>
                        <option value="1">⭐☆☆☆☆ Poor</option>
                        <option value="0">☆☆☆☆☆ Irrelevant / No Answer</option>
                    </select>
                </td>
                <td class="comments-cell" style="border: 1px solid #ddd;">
                    <textarea class="comment-field" data-test-id="{{assistant.test_id}}" 
                              placeholder="Enter your detailed feedback about this response..." 
                              style="width: 100%; min-height: 60px; padding: 6px; border: 1px solid #ccc; border-radius: 4px; resize: vertical; font-family: inherit; font-size: 0.9em; line-height: 1.4;"
                              rows="3"></textarea>
                </td>
            </tr>
            {%- endfor %}
        </tbody>
    </table>
</div>

{% endif %}
